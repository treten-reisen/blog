---
import * as dateFns from "date-fns"

import BlocksRenderer from "../../components/blocks-renderer"
import Comments from "../../components/comments.astro"
import Seo from "../../components/Seo.astro"
import { getArticle } from "../../data/get-article"
import { getArticleList, StrapiArticleListItem } from "../../data/get-article-list"
import { getGlobal } from "../../data/get-global"
import Layout from "../../layouts/Layout.astro"

import "./article.css"

export async function getStaticPaths() {
  const articles = await getArticleList({ includeUnlisted: true })

  return articles.data.map(article => ({
    params: { slug: article.attributes.slug },
    props: { article },
  }))
}

export type Props = {
  article: StrapiArticleListItem
}

const {
  article: { id },
} = Astro.props as Props
const global = await getGlobal()
const article = await getArticle(id)
---

<Layout>
  <Seo type="article" global={global.data} seo={article.data.attributes.seo} slot="seo" />

  <article class="flex h-full flex-col font-serif">
    <div class="flex w-full justify-end mb-2 max-w-prose">
      <span class="font-sans text-gray-500">
        {
          article.data.attributes.publishedAt &&
            (article.data.attributes.publishedAt.toDateString() === article.data.attributes.updatedAt.toDateString()
              ? dateFns.intlFormat(
                  article.data.attributes.publishedAt,
                  { year: "numeric", month: "long", day: "numeric" },
                  { locale: "de" }
                )
              : `aktualisiert am ${dateFns.intlFormat(
                  article.data.attributes.updatedAt,
                  { year: "numeric", month: "long", day: "numeric" },
                  { locale: "de" }
                )}`)
        }
      </span>
    </div>

    <div class="flex-1 mb-6 sm:mb-responsive">
      <BlocksRenderer blocks={article.data.attributes.blocks} />
    </div>
    {
      article.data.attributes.listed && (
        <div class="mt-responsive font-sans">
          <Comments
            url={new URL(`/articles/${article.data.attributes.slug}`, global.data.attributes.siteURL).toString()}
            identifier={`treten-reisen.article.${article.data.id}`}
            title={article.data.attributes.seo.metaTitle || "treten.reisen"}
          />
        </div>
      )
    }
  </article>
</Layout>
